# CS (Common Source) State Implementation Context

## Overview

This document captures the comprehensive discussion and implementation changes regarding CS (Common Source) state handling in the BabyLM system, including the refactoring of maps and the transition from CS as a special-case "kick" mechanism to an extra-phenomenal boundary axiom.

## Background: The CS Problem

### Original Implementation Issues

The CS state was originally implemented as a special-case "kick" mechanism throughout the codebase:

1. **Special-case filtering in intelligence.py**: Token generation included PCE (Parity-Conserving Emission) logic that filtered tokens without drive bits when in CS state
2. **Asymmetric emission in kernel files**: Both `kernel.py`, `kernel_plus.py`, and `gyro_head.py` contained special CS handling where:
   - Standing introns would leave CS invariant
   - Driving introns would emit to new states using `INTRON_BROADCAST_MASKS`
3. **Fast vectorized CS fixes in governance.py**: PCE hooks that provided special handling for CS state transitions
4. **Inconsistent tensor encoding**: Different encoding schemes between `governance.tensor_to_int` and `InformationEngine.tensor_to_int`

### State Count Discrepancy

The original physics should generate **788,986 states**, but the CS kick mechanism artificially inflated this to **789,170 states** (an additional 184 states).

## Solution: CS as Extra-Phenomenal Axiom

### Theoretical Framework

CS is now treated as an **extra-phenomenal pre-observable axiom** that exists at the boundary layer rather than within the core physics engine. This approach:

1. **Preserves physical purity**: Core physics operates on the original 788,986 states without special cases
2. **Maintains CS functionality**: CS behavior is handled through boundary selectors (œÄ) at the interface layer
3. **Eliminates asymmetric emission**: All states follow the same physical laws

### Implementation Changes

#### 1. Removed CS Kick Logic

**Files Modified:**
- `baby/intelligence.py`: Removed PCE token filtering in `generate_token_exon`
- `baby/kernel.py`: Removed CS asymmetric emission in `apply_gyration_and_transform`
- `baby/kernel_plus.py`: Removed CS special cases in `_apply_intron_and_gate`
- `kernel/gyro_head.py`: Removed CS special cases in `_apply_intron_and_gate`
- `baby/governance.py`: Removed "fast vectorised CS fix - PCE" blocks

#### 2. Unified Tensor Encoding

**governance.py tensor_to_int function:**
```python
# Updated to match InformationEngine encoding:
# +1 ‚Üí 0, -1 ‚Üí 1
def tensor_to_int(tensor):
    bits = (tensor == -1).int()
    packed = torch.packbits(bits.byte(), dim=-1)
    return int(packed.sum().item())
```

#### 3. Boundary Selector Implementation

**governance.py:**
- Added `apply_boundary_selector` function
- Added `apply_cs_boundary_transition` function
- Uses `GENE_Mac_S` for CS boundary handling

## Maps and Regeneration

### Three Critical Maps

1. **Ontology Map** (`information.py`): Maps states to their fundamental properties
   - Expected size: 788,986 states
   - Generated by `discover_and_save_ontology(output_path)`

2. **Epistemology Table**: Knowledge representation mapping
   - Depends on corrected ontology
   - Requires regeneration after ontology fix

3. **Phenomenology Map**: Observable phenomena mapping
   - Depends on corrected ontology
   - Requires regeneration after ontology fix

### Regeneration Process

The maps must be regenerated in order:
1. **Ontology** (in progress)
2. **Epistemology** (pending)
3. **Phenomenology** (pending)

## Technical Details

### State Encoding

**Original Inconsistency:**
- `governance.tensor_to_int`: Used bitwise operations
- `InformationEngine.tensor_to_int`: Used +1‚Üí0, -1‚Üí1 mapping

**Unified Approach:**
Both now use the same encoding where:
- `+1` maps to `0`
- `-1` maps to `1`

### CS State Identification

- `CS_STATE_INDEX`: Identified as minimum theta
- `CS_STATE_INT`: Value of 0
- `governance.CS_INT`: Also 0

### Boundary Layer Architecture

CS handling now occurs at the boundary through:
- **Boundary selectors (œÄ)**: Interface between core physics and CS requirements
- **Extra-phenomenal treatment**: CS exists outside the observable physics domain
- **Pre-observable axiom**: CS is a foundational assumption rather than a physical state

## Implementation Status

### Completed Tasks
- ‚úÖ Removed CS kick logic from `governance.py`
- ‚úÖ Updated `information.py` to expect 788,986 states
- ‚úÖ Implemented boundary selector œÄ
- ‚úÖ Removed CS kick logic from `intelligence.py`
- ‚úÖ Removed CS kick logic from kernel files
- ‚úÖ Unified tensor encoding
- ‚úÖ Removed PCE hooks from governance

### Pending Tasks
- üîÑ Regenerate ontology map (in progress)
- ‚è≥ Regenerate epistemology table
- ‚è≥ Regenerate phenomenology map
- ‚è≥ Update docstrings to reflect CS as extra-phenomenal
- ‚è≥ Update test expectations for corrected state count

## Key Insights

1. **Physics Purity**: Separating CS from core physics maintains mathematical elegance
2. **Boundary Pattern**: Extra-phenomenal handling provides clean architecture
3. **State Count Accuracy**: Original physics generates exactly 788,986 states
4. **Encoding Consistency**: Unified tensor-to-int mapping eliminates discrepancies
5. **Map Dependencies**: Ontology must be regenerated before epistemology and phenomenology

## Future Considerations

- Monitor performance impact of boundary layer approach
- Validate that CS functionality is preserved through boundary selectors
- Ensure test coverage for the new architecture
- Document the extra-phenomenal axiom pattern for future reference

This refactoring represents a significant architectural improvement, moving from ad-hoc special cases to a principled boundary layer approach that maintains both physical purity and functional requirements.